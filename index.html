<!DOCTYPE html>
<html>
<head>
<title>Warranty System</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
body{
  background:#0f172a;
  color:white;
  font-family:Arial;
  padding:30px;
}
.container{
  max-width:750px;
  margin:auto;
  background:#1e293b;
  padding:25px;
  border-radius:12px;
  box-shadow:0 0 15px rgba(0,0,0,.4);
}
button{
  padding:10px 18px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  background:#38bdf8;
  color:black;
  font-weight:bold;
}
button:hover{
  background:#7dd3fc;
}
input{
  width:100%;
  padding:10px;
  margin:5px 0 10px 0;
  border-radius:8px;
  border:none;
  background:#334155;
  color:white;
}
.tab{
  display:inline-block;
  padding:12px 18px;
  background:#334155;
  margin-right:5px;
  border-radius:8px;
  cursor:pointer;
}
.tab.active{
  background:#38bdf8;
  color:black;
  font-weight:bold;
}
.section{ display:none; }
</style>
</head>

<body>

<div class="container">

<h2>產品保固卡系統</h2>

<div>
  <span class="tab active" onclick="showTab('admin')">企業管理端</span>
  <span class="tab" onclick="showTab('user')">消費者端</span>
</div>

<hr>

<button onclick="connect()">Connect MetaMask</button>
<p id="wallet"></p>

<!-- ================= ADMIN ================= -->
<div id="admin" class="section" style="display:block">

<h3>建立產品保固卡資訊</h3>
<input id="pid" placeholder="產品序號 (ex: SN1001)">
<input id="owner" placeholder="擁有者地址">
<input id="days" type="number" placeholder="保固天數 (ex: 365)">
<button onclick="createWarranty()">Create Warranty</button>
<p id="createResult"></p>

<hr>

<h3>轉移保固卡所有權</h3>
<input id="adminPid" placeholder="產品序號">
<input id="adminNewOwner" placeholder="新擁有者">
<button onclick="adminTransfer()">Transfer</button>
<p id="adminTransferMsg"></p>

</div>

<!-- ================= USER ================= -->
<div id="user" class="section">

<h3>查詢產品保固卡資訊</h3>
<input id="queryPid" placeholder="產品序號">
<button onclick="getWarranty()">Search</button>
<p id="result"></p>

<hr>

<h3>轉移保固卡所有權</h3>
<input id="transferPid" placeholder="產品序號">
<input id="newOwner" placeholder="新擁有者">
<button onclick="transferWarranty()">Transfer</button>
<p id="transferMsg"></p>

</div>

</div>

<script>
// ⭐ 你的合約地址
const contractAddress = "0xd4f8c5e0a23225D9853B7fFFbb9A8bd073274125";

// ⭐ ABI
const abi = [
  {
    "inputs":[
      {"internalType":"string","name":"_productId","type":"string"},
      {"internalType":"address","name":"_owner","type":"address"},
      {"internalType":"uint256","name":"_durationDays","type":"uint256"}
    ],
    "name":"createWarranty",
    "outputs":[],
    "stateMutability":"nonpayable",
    "type":"function"
  },
  {
    "inputs":[{"internalType":"string","name":"_productId","type":"string"}],
    "name":"getWarranty",
    "outputs":[
      {"internalType":"address","name":"owner","type":"address"},
      {"internalType":"uint256","name":"startDate","type":"uint256"},
      {"internalType":"uint256","name":"endDate","type":"uint256"},
      {"internalType":"bool","name":"isActive","type":"bool"}
    ],
    "stateMutability":"view",
    "type":"function"
  },
  {
    "inputs":[
      {"internalType":"string","name":"_productId","type":"string"},
      {"internalType":"address","name":"_newOwner","type":"address"}
    ],
    "name":"transferWarranty",
    "outputs":[],
    "stateMutability":"nonpayable",
    "type":"function"
  }
];

let signer, contract;

// ================= TAB =================
function showTab(name){
  document.querySelectorAll(".section").forEach(s=>s.style.display="none");
  document.getElementById(name).style.display="block";

  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  event.target.classList.add("active");
}

// ================= CONNECT =================
async function connect(){
  const provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts",[]);
  signer = provider.getSigner();
  contract = new ethers.Contract(contractAddress, abi, signer);
  wallet.innerText = "Connected: " + await signer.getAddress();
}

// ================= ADMIN =================
async function createWarranty(){
  try{
    const tx = await contract.createWarranty(
      pid.value,
      owner.value,
      Number(days.value)
    );
    await tx.wait();
    createResult.innerText="建立成功";
  }catch(e){
    createResult.innerText="失敗";
  }
}

async function adminTransfer(){
  try{
    const tx = await contract.transferWarranty(
      adminPid.value,
      adminNewOwner.value
    );
    await tx.wait();
    adminTransferMsg.innerText="轉移完成";
  }catch(e){
    adminTransferMsg.innerText="轉移失敗";
  }
}

// ================= USER =================
async function getWarranty(){
  try{
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const read = new ethers.Contract(contractAddress, abi, provider);
    const w = await read.getWarranty(queryPid.value);

    const start = new Date(Number(w.startDate)*1000);
    const end = new Date(Number(w.endDate)*1000);

    result.innerHTML = `
      <p>Owner: ${w.owner}</p>
      <p>Start: ${start.toLocaleString()}</p>
      <p>End: ${end.toLocaleString()}</p>
      <p style="color:${w.isActive?'lightgreen':'red'};font-weight:bold;">
        狀態：${w.isActive?'有效':'已過期'}
      </p>
    `;
  }catch(e){
    result.innerText="查無資料或錯誤";
  }
}

async function transferWarranty(){
  try{
    const tx = await contract.transferWarranty(
      transferPid.value,
      newOwner.value
    );
    await tx.wait();
    transferMsg.innerText="轉移成功";
  }catch(e){
    transferMsg.innerText="轉移失敗";
  }
}
</script>

</body>
</html>
