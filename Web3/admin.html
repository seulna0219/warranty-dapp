<!DOCTYPE html>
<html>
<head>
<title>保固管理</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<link rel="stylesheet" href="style.css">
</head>

<body>
<div class="container">
<h2>Warranty Admin</h2>
<button onclick="connect()">Connect MetaMask</button>
<p id="wallet"></p>

<hr>

<h3>建立產品保固卡資訊</h3>
<input id="pid" placeholder="產品序號 (ex: SN1001)">
<input id="owner" placeholder="擁有者地址">
<input id="days" type="number" placeholder="保固天數 (ex: 365)">
<button onclick="createWarranty()">Create Warranty</button>
<p id="createResult"></p>

<hr>

<h3>轉移保固卡所有權</h3>
<input id="tpid" placeholder="產品序號">
<input id="newOwner" placeholder="新擁有者地址">
<button onclick="transfer()">Transfer</button>
<p id="transferResult"></p>

</div>

<script>
const contractAddress = "0xd4f8c5e0a23225D9853B7fFFbb9A8bd073274125";

const abi = [
  {
    "inputs": [
      { "internalType": "string", "name": "_productId", "type": "string" },
      { "internalType": "address", "name": "_owner", "type": "address" },
      { "internalType": "uint256", "name": "_durationDays", "type": "uint256" }
    ],
    "name": "createWarranty",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },

  {
    "inputs": [
      { "internalType": "string", "name": "_productId", "type": "string" }
    ],
    "name": "getWarranty",
    "outputs": [
      { "internalType": "address", "name": "owner", "type": "address" },
      { "internalType": "uint256", "name": "startDate", "type": "uint256" },
      { "internalType": "uint256", "name": "endDate", "type": "uint256" },
      { "internalType": "bool", "name": "isActive", "type": "bool" }
    ],
    "stateMutability": "view",
    "type": "function"
  },

  {
    "inputs": [
      { "internalType": "string", "name": "_productId", "type": "string" },
      { "internalType": "address", "name": "_newOwner", "type": "address" }
    ],
    "name": "transferWarranty",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  }
];


let contract, signer;

async function connect(){
 const provider = new ethers.providers.Web3Provider(window.ethereum);
 await provider.send("eth_requestAccounts",[]);
 signer = provider.getSigner();
 contract = new ethers.Contract(contractAddress, abi, signer);
 document.getElementById("wallet").innerText =
 "Connected: " + await signer.getAddress();
}

async function createWarranty(){
 try{
   const tx = await contract.createWarranty(
     pid.value,
     owner.value,
     Number(days.value)
   );
   await tx.wait();
   createResult.innerText = "建立成功！已寫入區塊鏈";
 }catch(e){ createResult.innerText = e.message; }
}

async function transfer(){
 try{
   const tx = await contract.transferWarranty(
     tpid.value,
     newOwner.value
   );
   await tx.wait();
   transferResult.innerText = "轉移完成";
 }catch(e){ transferResult.innerText = e.message; }
}
</script>
</body>
</html>